package com.example.dawnshift.ui.screens

import android.media.RingtoneManager
import android.net.Uri
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.rememberLazyListState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.animation.core.animateDpAsState
import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.animation.core.tween
import androidx.compose.animation.core.FastOutSlowInEasing
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.ArrowDropDown
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material.icons.filled.Remove
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.alpha
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.input.nestedscroll.nestedScroll
import androidx.compose.ui.layout.onGloballyPositioned
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.util.lerp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.example.dawnshift.alarms.WakeUpReceiver
import com.example.dawnshift.ui.components.HEADER_COLLAPSED_HEIGHT
import com.example.dawnshift.ui.viewmodel.ItemStatus
import com.example.dawnshift.ui.viewmodel.ScheduleItemData
import com.example.dawnshift.ui.viewmodel.WakeSettingsViewModel
import kotlinx.coroutines.launch
import java.time.LocalTime
import java.time.format.DateTimeFormatter
import java.time.format.FormatStyle

@OptIn(ExperimentalMaterial3Api::class, ExperimentalFoundationApi::class)
@Composable
fun WakeSettingsScreen(
    viewModel: WakeSettingsViewModel = viewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    val context = LocalContext.current
    val timeFormatter = DateTimeFormatter.ofLocalizedTime(FormatStyle.SHORT)

    // State for TimePicker Dialogs
    var showStartTimePicker by remember { mutableStateOf(false) }
    var showTargetTimePicker by remember { mutableStateOf(false) }

    // Permissions logic
    val notificationPermissionLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestPermission()
    ) { /* Permission handled */ }
    
    val ringtoneLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.StartActivityForResult()
    ) { result ->
        if (result.resultCode == android.app.Activity.RESULT_OK) {
            val uri: Uri? = result.data?.getParcelableExtra(RingtoneManager.EXTRA_RINGTONE_PICKED_URI)
            viewModel.updateAlarmSound(uri?.toString() ?: "")
        }
    }
    
    var ringtoneTitle by remember { mutableStateOf("Default") }
    LaunchedEffect(uiState.alarmSoundUri) {
        if (uiState.alarmSoundUri.isNotEmpty()) {
            val ringtone = RingtoneManager.getRingtone(context, Uri.parse(uiState.alarmSoundUri))
            ringtoneTitle = ringtone?.getTitle(context) ?: "Unknown"
        } else {
             ringtoneTitle = "Default"
        }
    }
    
    var hasOverlayPermission by remember { mutableStateOf(android.provider.Settings.canDrawOverlays(context)) }
    val lifecycleOwner = androidx.lifecycle.compose.LocalLifecycleOwner.current
    DisposableEffect(lifecycleOwner) {
        val observer = androidx.lifecycle.LifecycleEventObserver { _, event ->
            if (event == androidx.lifecycle.Lifecycle.Event.ON_RESUME) {
                hasOverlayPermission = android.provider.Settings.canDrawOverlays(context)
            }
        }
        lifecycleOwner.lifecycle.addObserver(observer)
        onDispose { lifecycleOwner.lifecycle.removeObserver(observer) }
    }

    
    // Header Metrics
    val density = LocalDensity.current
    var headerHeightPx by remember { mutableFloatStateOf(with(density) { 450.dp.toPx() }) }
    val minHeaderHeightPx = with(density) { 64.dp.toPx() }
    
    // Scroll State
    val listState = rememberLazyListState()
    val scope = rememberCoroutineScope()
    var scrollOffset by remember { mutableFloatStateOf(0f) }
    
    val nestedScrollConnection = remember(headerHeightPx, minHeaderHeightPx, listState) {
        object : androidx.compose.ui.input.nestedscroll.NestedScrollConnection {
            override fun onPreScroll(available: androidx.compose.ui.geometry.Offset, source: androidx.compose.ui.input.nestedscroll.NestedScrollSource): androidx.compose.ui.geometry.Offset {
                val delta = available.y
                val maxOffset = -(headerHeightPx - minHeaderHeightPx)
                
                // If scrolling down (delta < 0) and we can collapse more
                if (delta < 0 && scrollOffset > maxOffset) {
                    val newOffset = (scrollOffset + delta).coerceAtLeast(maxOffset)
                    val consumed = newOffset - scrollOffset
                    scrollOffset = newOffset
                    return androidx.compose.ui.geometry.Offset(0f, consumed)
                }
                return androidx.compose.ui.geometry.Offset.Zero
            }
            
            override fun onPostScroll(consumed: androidx.compose.ui.geometry.Offset, available: androidx.compose.ui.geometry.Offset, source: androidx.compose.ui.input.nestedscroll.NestedScrollSource): androidx.compose.ui.geometry.Offset {
                val delta = available.y
                // Only expand header if scrolling up (delta > 0), header is not fully expanded, AND list is at top
                if (delta > 0 && scrollOffset < 0f && listState.firstVisibleItemIndex == 0 && listState.firstVisibleItemScrollOffset == 0) {
                    val newOffset = (scrollOffset + delta).coerceAtMost(0f)
                    val consumedY = newOffset - scrollOffset
                    scrollOffset = newOffset
                    return androidx.compose.ui.geometry.Offset(0f, consumedY)
                }
                return androidx.compose.ui.geometry.Offset.Zero
            }
        }
    }

    Scaffold(
        modifier = Modifier.fillMaxSize(),
        containerColor = MaterialTheme.colorScheme.background,
        bottomBar = {
            // Floating Pill Button
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .navigationBarsPadding()
                    .padding(horizontal = 20.dp, vertical = 16.dp),
                contentAlignment = Alignment.Center
            ) {
                if (uiState.alarmsSet) {
                     Button(
                        onClick = {
                            viewModel.cancelAllAlarms()
                            Toast.makeText(context, "All alarms cancelled", Toast.LENGTH_SHORT).show()
                        },
                        colors = ButtonDefaults.buttonColors(
                            containerColor = MaterialTheme.colorScheme.errorContainer,
                            contentColor = MaterialTheme.colorScheme.error
                        ),
                        shape = RoundedCornerShape(28.dp),
                        modifier = Modifier.fillMaxWidth().height(56.dp),
                        elevation = ButtonDefaults.buttonElevation(defaultElevation = 4.dp)
                    ) {
                        Text("Cancel All Alarms", fontWeight = FontWeight.Bold)
                    }
                } else {
                    Button(
                        onClick = {
                            val alarmManager = context.getSystemService(android.content.Context.ALARM_SERVICE) as android.app.AlarmManager
                            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {
                                if (!alarmManager.canScheduleExactAlarms()) {
                                    val intent = android.content.Intent(android.provider.Settings.ACTION_REQUEST_SCHEDULE_EXACT_ALARM)
                                    context.startActivity(intent)
                                    return@Button
                                }
                            }
                            
                            if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.TIRAMISU) {
                                if (androidx.core.content.ContextCompat.checkSelfPermission(context, android.Manifest.permission.POST_NOTIFICATIONS) != android.content.pm.PackageManager.PERMISSION_GRANTED) {
                                    notificationPermissionLauncher.launch(android.Manifest.permission.POST_NOTIFICATIONS)
                                    return@Button
                                }
                            }
                            
                            viewModel.scheduleAllAlarms()
                            Toast.makeText(context, "Alarms scheduled!", Toast.LENGTH_SHORT).show()
                        },
                        modifier = Modifier.fillMaxWidth().height(56.dp),
                        shape = RoundedCornerShape(28.dp),
                        colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.primary),
                        elevation = ButtonDefaults.buttonElevation(defaultElevation = 4.dp)
                    ) {
                        Text("Set Alarms", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
                    }
                }
            }
        }
    ) { innerPadding ->
        Box(modifier = Modifier.fillMaxSize()) {
            LazyColumn(
                state = listState,
                modifier = Modifier
                    .fillMaxSize(),
                contentPadding = PaddingValues(
                    top = 0.dp,
                    bottom = innerPadding.calculateBottomPadding() + 16.dp
                ),
                verticalArrangement = Arrangement.spacedBy(0.dp)
            ) {
                // Sticky Collapsing Header
                    stickyHeader {
                        val scrollProgress = remember {
                            derivedStateOf {
                                val firstItemOffset = listState.firstVisibleItemScrollOffset
                                val firstItemIndex = listState.firstVisibleItemIndex
                                
                                // Calculate collapse fraction based on scroll
                                if (firstItemIndex == 0) {
                                    (firstItemOffset / 300f).coerceIn(0f, 1f)
                                } else {
                                    1f // Fully collapsed if scrolled past first item
                                }
                            }
                        }
                        
                        val collapseFraction by remember { scrollProgress }
                        
                        // Simple animated values
                        val headerHeight by animateDpAsState(
                            targetValue = if (collapseFraction < 0.5f) 100.dp else 64.dp,
                            animationSpec = tween(durationMillis = 200, easing = FastOutSlowInEasing),
                            label = "headerHeight"
                        )
                        
                        val titleSize by animateFloatAsState(
                            targetValue = androidx.compose.ui.util.lerp(28f, 20f, collapseFraction),
                            animationSpec = tween(durationMillis = 200, easing = FastOutSlowInEasing),
                            label = "titleSize"
                        )
                        
                        val subtitleAlpha = (1f - collapseFraction * 2f).coerceIn(0f, 1f)
                        val collapsedAlpha = (collapseFraction * 2f - 1f).coerceIn(0f, 1f)
                        
                        Surface(
                            modifier = Modifier
                                .fillMaxWidth()
                                .statusBarsPadding()
                                .height(headerHeight),
                            color = MaterialTheme.colorScheme.background,
                            shadowElevation = if (collapseFraction > 0.3f) 3.dp else 0.dp
                        ) {
                            Box(
                                modifier = Modifier
                                    .fillMaxSize()
                                    .padding(horizontal = 20.dp)
                            ) {
                                // Title
                                Text(
                                    text = "Dawn Shift ðŸŒ…",
                                    fontSize = titleSize.sp,
                                    fontWeight = FontWeight.Bold,
                                    color = MaterialTheme.colorScheme.primary,
                                    modifier = Modifier.align(Alignment.CenterStart)
                                )
                                
                                // Subtitle
                                if (subtitleAlpha > 0.01f) {
                                    Text(
                                        text = "Wake up earlier, gently.",
                                        style = MaterialTheme.typography.bodyMedium,
                                        color = MaterialTheme.colorScheme.onSurfaceVariant,
                                        modifier = Modifier
                                            .align(Alignment.BottomStart)
                                            .padding(bottom = 12.dp)
                                            .alpha(subtitleAlpha)
                                    )
                                }
                                
                                // Collapsed chip/progress
                                if (collapsedAlpha > 0.01f) {
                                    if (uiState.alarmsSet) {
                                        Box(
                                            contentAlignment = Alignment.Center,
                                            modifier = Modifier
                                                .align(Alignment.CenterEnd)
                                                .alpha(collapsedAlpha)
                                        ) {
                                            CircularProgressIndicator(
                                                progress = { if (uiState.days > 0) uiState.completedCount / uiState.days.toFloat() else 0f },
                                                modifier = Modifier.size(40.dp),
                                                color = MaterialTheme.colorScheme.primary,
                                                trackColor = MaterialTheme.colorScheme.surfaceVariant,
                                                strokeWidth = 4.dp
                                            )
                                        }
                                    } else {
                                        Surface(
                                            onClick = {
                                                scope.launch {
                                                    listState.animateScrollToItem(0, 0)
                                                }
                                            },
                                            shape = CircleShape,
                                            color = MaterialTheme.colorScheme.secondaryContainer,
                                            modifier = Modifier
                                                .align(Alignment.CenterEnd)
                                                .height(40.dp)
                                                .alpha(collapsedAlpha)
                                        ) {
                                            Row(
                                                verticalAlignment = Alignment.CenterVertically,
                                                modifier = Modifier.padding(horizontal = 14.dp, vertical = 8.dp)
                                            ) {
                                                Text(
                                                    "${uiState.startTime.format(timeFormatter)} â†’ ${uiState.targetTime.format(timeFormatter)}",
                                                    style = MaterialTheme.typography.labelMedium,
                                                    fontWeight = FontWeight.Bold,
                                                    color = MaterialTheme.colorScheme.onSecondaryContainer
                                                )
                                                Spacer(Modifier.width(6.dp))
                                                Text(
                                                    "${uiState.days}d",
                                                    style = MaterialTheme.typography.labelSmall,
                                                    color = MaterialTheme.colorScheme.onSecondaryContainer.copy(alpha = 0.8f)
                                                )
                                                Spacer(Modifier.width(4.dp))
                                                Icon(
                                                    Icons.Default.ArrowDropDown,
                                                    contentDescription = "Expand",
                                                    tint = MaterialTheme.colorScheme.onSecondaryContainer,
                                                    modifier = Modifier.size(20.dp)
                                                )
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Content starts here with proper spacing
                    item {
                        Spacer(modifier = Modifier.height(20.dp))
                    }
                    
                    // Configuration Card
                if (!uiState.alarmsSet) {
                    item {
                        Box(modifier = Modifier.padding(horizontal = 20.dp)) {
                            Card(
                                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surfaceVariant),
                                modifier = Modifier.fillMaxWidth()
                            ) {
                            Column(
                                modifier = Modifier.padding(20.dp),
                                verticalArrangement = Arrangement.spacedBy(16.dp)
                            ) {
                                TimeInputRow("Current Wake Time", uiState.startTime, { showStartTimePicker = true }, timeFormatter)
                                HorizontalDivider(color = MaterialTheme.colorScheme.outlineVariant)
                                TimeInputRow("Target Wake Time", uiState.targetTime, { showTargetTimePicker = true }, timeFormatter)
                                HorizontalDivider(color = MaterialTheme.colorScheme.outlineVariant)
                                DaysPickerRow(uiState.days, { viewModel.updateDays(it.toString()) })
                                HorizontalDivider(color = MaterialTheme.colorScheme.outlineVariant)
                                
                                Row(
                                    modifier = Modifier.fillMaxWidth().clickable {
                                        val intent = android.content.Intent(RingtoneManager.ACTION_RINGTONE_PICKER).apply {
                                            putExtra(RingtoneManager.EXTRA_RINGTONE_TYPE, RingtoneManager.TYPE_ALARM)
                                            putExtra(RingtoneManager.EXTRA_RINGTONE_TITLE, "Select Alarm Sound")
                                            val currentUri = if (uiState.alarmSoundUri.isNotEmpty()) Uri.parse(uiState.alarmSoundUri) else null
                                            putExtra(RingtoneManager.EXTRA_RINGTONE_EXISTING_URI, currentUri)
                                            putExtra(RingtoneManager.EXTRA_RINGTONE_SHOW_SILENT, false)
                                            putExtra(RingtoneManager.EXTRA_RINGTONE_SHOW_DEFAULT, true)
                                        }
                                        ringtoneLauncher.launch(intent)
                                    },
                                    verticalAlignment = Alignment.CenterVertically
                                ) {
                                    Column(modifier = Modifier.weight(1f)) {
                                        Text("Alarm Sound", style = MaterialTheme.typography.bodyMedium)
                                        Text(ringtoneTitle, style = MaterialTheme.typography.labelMedium, color = MaterialTheme.colorScheme.primary)
                                    }
                                }
                            }
                        }
                    }
                }
            } else {
                // Progress Card when alarms are set
                item {
                        Box(modifier = Modifier.padding(horizontal = 20.dp)) {
                            Card(
                                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.primaryContainer),
                                modifier = Modifier.fillMaxWidth()
                            ) {
                            Row(
                                modifier = Modifier.padding(20.dp).fillMaxWidth(),
                                horizontalArrangement = Arrangement.SpaceBetween,
                                verticalAlignment = Alignment.CenterVertically
                            ) {
                                Column(modifier = Modifier.weight(1f)) {
                                    Text(
                                        text = "Plan in Progress",
                                        style = MaterialTheme.typography.titleSmall,
                                        fontWeight = FontWeight.Bold,
                                        color = MaterialTheme.colorScheme.primary
                                    )
                                    Spacer(modifier = Modifier.height(4.dp))
                                    Text(
                                        text = "${uiState.completedCount} of ${uiState.days} days completed",
                                        style = MaterialTheme.typography.bodyMedium
                                    )
                                }
                                // Circular progress indicator
                                Box(contentAlignment = Alignment.Center) {
                                    CircularProgressIndicator(
                                        progress = { if (uiState.days > 0) uiState.completedCount / uiState.days.toFloat() else 0f },
                                        modifier = Modifier.size(56.dp),
                                        color = MaterialTheme.colorScheme.primary,
                                        trackColor = MaterialTheme.colorScheme.surfaceVariant,
                                        strokeWidth = 6.dp
                                    )
                                    Text(
                                        text = "${((if (uiState.days > 0) uiState.completedCount / uiState.days.toFloat() else 0f) * 100).toInt()}%",
                                        style = MaterialTheme.typography.labelSmall,
                                        fontWeight = FontWeight.Bold,
                                        color = MaterialTheme.colorScheme.primary
                                    )
                                }
                            }
                            }
                        }
                    }
                }
                
                // Permissions Warning
                 if (!hasOverlayPermission) {
                    item {
                        Box(modifier = Modifier.padding(horizontal = 20.dp)) {
                            Card(
                                colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.errorContainer.copy(alpha=0.1f)),
                                border = androidx.compose.foundation.BorderStroke(1.dp, MaterialTheme.colorScheme.error.copy(alpha=0.5f))
                            ) {
                            Column(modifier = Modifier.padding(16.dp)) {
                                Text(
                                    text = "Permission Required",
                                    style = MaterialTheme.typography.titleSmall,
                                    fontWeight = FontWeight.Bold,
                                    color = MaterialTheme.colorScheme.error
                                )
                                Text(
                                    text = "To show the full-screen alarm, please allow 'Display over other apps'.",
                                    style = MaterialTheme.typography.bodySmall,
                                    modifier = Modifier.padding(vertical = 8.dp),
                                    color = MaterialTheme.colorScheme.onSurface
                                )
                                Button(
                                    onClick = {
                                        val intent = android.content.Intent(
                                            android.provider.Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                                            android.net.Uri.parse("package:${context.packageName}")
                                        )
                                        context.startActivity(intent)
                                    },
                                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.error),
                                    contentPadding = PaddingValues(horizontal = 16.dp, vertical = 8.dp),
                                    modifier = Modifier.height(36.dp)
                                ) {
                                    Text("Grant Permission", style = MaterialTheme.typography.labelSmall)
                                }
                            }
                            }
                        }
                    }
                }
                
                if (uiState.isTestMode) {
                    item {
                        Box(modifier = Modifier.padding(horizontal = 20.dp)) {
                            TestModeControls(uiState, onAdvance = { viewModel.advanceTime() }, onReset = { viewModel.resetTime() }, context = context)
                        }
                    }
                }

                // Schedule List
                item {
                    Box(modifier = Modifier.padding(horizontal = 20.dp)) {
                        Text(
                        text = if (uiState.alarmsSet) "Your Schedule" else "Preview Schedule",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold,
                        modifier = Modifier.padding(bottom = 8.dp, start = 4.dp)
                    )
                    
                        Card(
                             colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.surface),
                             elevation = CardDefaults.cardElevation(defaultElevation = 2.dp),
                             modifier = Modifier.fillMaxWidth()
                        ) {
                        val list = if (uiState.alarmsSet) uiState.activeSchedule else uiState.schedule
                        Column(
                            modifier = Modifier.padding(16.dp)
                        ) {
                            if (list.isEmpty()) {
                                Text("No schedule generated yet.", modifier = Modifier.padding(8.dp))
                            } else {
                                list.forEachIndexed { index, item ->
                                    ScheduleRow(
                                        item = item,
                                        formatter = timeFormatter,
                                        isTestMode = uiState.isTestMode,
                                        isSnoozed = (uiState.alarmsSet && uiState.snoozedAlarmIndex == index),
                                        snoozeUntilMillis = uiState.snoozeUntilEpochMillis,
                                        onManualComplete = { viewModel.manuallyCompleteDay(index) },
                                        onDismissSnooze = { viewModel.dismissSnooze() }
                                    )
                                    if (index < list.lastIndex) {
                                        HorizontalDivider(
                                            color = MaterialTheme.colorScheme.outlineVariant.copy(alpha=0.5f),
                                            modifier = Modifier.padding(vertical = 8.dp)
                                        )
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    if (showStartTimePicker) {
        TimePickerDialog(
            onDismissRequest = { showStartTimePicker = false },
            onConfirm = { viewModel.updateStartTime(it); showStartTimePicker = false },
            initialTime = uiState.startTime
        )
    }
    if (showTargetTimePicker) {
        TimePickerDialog(
            onDismissRequest = { showTargetTimePicker = false },
            onConfirm = { viewModel.updateTargetTime(it); showTargetTimePicker = false },
            initialTime = uiState.targetTime
        )
    }
}

@Composable
fun ScheduleRow(
    item: ScheduleItemData,
    formatter: DateTimeFormatter,
    isTestMode: Boolean,
    isSnoozed: Boolean,
    snoozeUntilMillis: Long,
    onManualComplete: () -> Unit,
    onDismissSnooze: () -> Unit
) {
    val dateFormatter = DateTimeFormatter.ofPattern("MMM d")
    val isNext = item.status == ItemStatus.NEXT
    val isCompleted = item.status == ItemStatus.COMPLETED
    
    Row(
        modifier = Modifier.fillMaxWidth().padding(vertical = 4.dp),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Row(verticalAlignment = Alignment.CenterVertically) {
           Box(
               modifier = Modifier
                   .size(32.dp)
                   .clip(RoundedCornerShape(8.dp))
                   .background(
                       when {
                           isCompleted -> MaterialTheme.colorScheme.tertiaryContainer
                           isNext -> MaterialTheme.colorScheme.primaryContainer
                           else -> MaterialTheme.colorScheme.surfaceVariant
                       }
                   ),
               contentAlignment = Alignment.Center
           ) {
               if (isCompleted) {
                   Icon(Icons.Filled.CheckCircle, null, tint = MaterialTheme.colorScheme.tertiary, modifier = Modifier.size(20.dp))
               } else {
                   Text(
                       "${item.dayIndex}",
                       style = MaterialTheme.typography.labelMedium,
                       fontWeight = FontWeight.Bold,
                       color = if (isNext) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurfaceVariant
                   )
               }
           }
           Spacer(modifier = Modifier.width(12.dp))
           Column {
               Text(
                   text = item.date.format(dateFormatter),
                   style = MaterialTheme.typography.bodySmall,
                   color = MaterialTheme.colorScheme.onSurfaceVariant
               )
               if (isSnoozed) {
                   Text("Snoozed", style = MaterialTheme.typography.labelSmall, color = MaterialTheme.colorScheme.tertiary)
               }
           }
        }
        
        Row(verticalAlignment = Alignment.CenterVertically) {
             Text(
                text = item.time.format(formatter),
                style = if (isNext) MaterialTheme.typography.titleMedium else MaterialTheme.typography.bodyLarge,
                fontWeight = if (isNext) FontWeight.Bold else FontWeight.Normal,
                color = if (isNext) MaterialTheme.colorScheme.primary else MaterialTheme.colorScheme.onSurface
            )
            
            if (isSnoozed) {
                Spacer(modifier = Modifier.width(8.dp))
                TextButton(onClick = onDismissSnooze, contentPadding = PaddingValues(0.dp), modifier = Modifier.height(30.dp)) {
                    Text("Dismiss", style = MaterialTheme.typography.labelSmall)
                }
            } else if (isTestMode && !isCompleted) {
                Spacer(modifier = Modifier.width(8.dp))
                TextButton(onClick = onManualComplete, contentPadding = PaddingValues(0.dp), modifier = Modifier.height(30.dp)) {
                    Text("Done", style = MaterialTheme.typography.labelSmall)
                }
            }
        }
    }
}

@Composable
fun TimeInputRow(label: String, time: LocalTime, onClick: () -> Unit, formatter: DateTimeFormatter) {
    Row(
        modifier = Modifier.fillMaxWidth().clickable(onClick = onClick),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Text(label, style = MaterialTheme.typography.bodyMedium)
        Text(
            time.format(formatter), 
            style = MaterialTheme.typography.titleMedium, 
            color = MaterialTheme.colorScheme.primary,
            fontWeight = FontWeight.SemiBold
        )
    }
}

@Composable
fun DaysPickerRow(days: Int, onDaysChanged: (Int) -> Unit) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        verticalAlignment = Alignment.CenterVertically,
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Text("Duration (Days)", style = MaterialTheme.typography.bodyMedium)
        Row(verticalAlignment = Alignment.CenterVertically) {
            IconButton(onClick = { if (days > 1) onDaysChanged(days - 1) }) {
                Icon(Icons.Filled.Remove, null)
            }
            Text("$days", style = MaterialTheme.typography.titleMedium, modifier = Modifier.width(30.dp), textAlign = TextAlign.Center)
            IconButton(onClick = { if (days < 120) onDaysChanged(days + 1) }) {
                Icon(Icons.Filled.Add, null)
            }
        }
    }
}

@Composable
fun TestModeControls(uiState: com.example.dawnshift.ui.viewmodel.WakeSettingsUiState, onAdvance: () -> Unit, onReset: () -> Unit, context: android.content.Context) {
    Card(colors = CardDefaults.cardColors(containerColor = MaterialTheme.colorScheme.errorContainer.copy(alpha=0.2f))) {
        Column(modifier = Modifier.padding(12.dp)) {
            Text("Test Mode: ${uiState.simulatedDate}", style = MaterialTheme.typography.labelSmall, color = MaterialTheme.colorScheme.error)
            Row(modifier = Modifier.padding(top = 8.dp), horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                Button(onClick = onAdvance, modifier = Modifier.weight(1f), colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.error)) { Text("+1 Day") }
                Button(onClick = onReset, modifier = Modifier.weight(1f), colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.error)) { Text("Reset") }
            }
            if (uiState.alarmsSet && uiState.nextIndex != -1) {
                Button(
                    onClick = {
                         val intent = android.content.Intent(context, WakeUpReceiver::class.java)
                         intent.putExtra("ALARM_INDEX", uiState.nextIndex)
                         context.sendBroadcast(intent)
                    },
                    modifier = Modifier.fillMaxWidth().padding(top = 8.dp),
                    colors = ButtonDefaults.buttonColors(containerColor = MaterialTheme.colorScheme.error)
                ) { Text("Force Alarm") }
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun TimePickerDialog(onDismissRequest: () -> Unit, onConfirm: (LocalTime) -> Unit, initialTime: LocalTime) {
    val timePickerState = rememberTimePickerState(initialHour = initialTime.hour, initialMinute = initialTime.minute)
    AlertDialog(
        onDismissRequest = onDismissRequest,
        confirmButton = { TextButton(onClick = { onConfirm(LocalTime.of(timePickerState.hour, timePickerState.minute)) }) { Text("OK") } },
        dismissButton = { TextButton(onClick = onDismissRequest) { Text("Cancel") } },
        text = { TimePicker(state = timePickerState) }
    )
}
